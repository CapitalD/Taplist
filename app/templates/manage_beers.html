{% extends "layout.html" %}
{% block body %}

<div class="page-header">
  <div class="btn-toolbar pull-right">
    <div class="btn-group" role="group" aria-label="beer actions">
      <button type="button" class="btn btn-default"  data-toggle="modal" data-target="#new-beer-modal" name="new_beer">Add beer...</button>
    </div>
    <div class="btn-group" role="group">
      <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Remove beer
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu">
        {% for b in brewery.beers|sort(attribute='name') %}
          <li><a href="{{ url_for('delete_beer', id=b.id) }}">{{ b.name }}</a></li>
        {% endfor %}
      </ul>
    </div>
  </div>
  <h1>Manage beers for {{ brewery.name }}</h1>
</div>

<div class="row">
  <div class="col-xs-10 col-xs-offset-1">

    <div class="row">
      <div class="col-xs-12">
        <table class="table table-striped table-hover">
          <thead>
            <th>Name</th>
            <th>Style</th>
            <th>ABV</th>
            <th colspan="2">Colour</th>
            <th>Pouring</th>
            <th></th>
          </thead>
          <tbody>
            {% for beer in brewery.beers|sort(attribute='name') %}
            <tr>
              <td>{{ beer.name }}</td>
              <td>{{ beer.style }}</td>
              <td>{{ beer.abv}}%</td>
              <td width="10px" id="colour{{ beer.id }}"></td>
              <td>{{ beer.colour }} EBC</td>
              {% if beer.taps.count() %}
                <td>Yes ({{ beer.taps.count() }})</td>
              {% else %}
                <td>No</td>
              {% endif %}
              <td><a href="#" name="edit_beer" data-beer-id="{{beer.id}}" class="btn btn-sm btn-default">Edit</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

  </div>
</div>

<!-- NEW MODAL -->
<div class="modal fade" id="new-beer-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <form action="/brewery/{{brewery.id}}/beer/new" method="post" name="new_beer">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Add a beer</h4>
        </div>
        <div class="modal-body">
          {{ new_beer.hidden_tag() }}
          <p>
            <label for="name">
              Beer name
                {{ new_beer.name(size="40", class_="form-control") }}
                {% for error in new_beer.name.errors %}
                  <span style="color: #f33;">[{{ error }}]</span>
                {% endfor %}
            </label>
          </p>

          <p>
            <label for="style">
              Beer style
                {{ new_beer.style(size="40", class_="form-control") }}
                {% for error in new_beer.style.errors %}
                  <span style="color: #f33;">[{{ error }}]</span>
                {% endfor %}
            </label>
          </p>

          <p>
            <label for="abv">
              Beer ABV
                <div class="input-group" style="width: 100px;">
                  {{ new_beer.abv(size="20", class_="form-control") }}
                  <div class="input-group-addon">
                    %
                  </div>
                </div>
                {% for error in new_beer.abv.errors %}
                  <span style="color: #f33;">[{{ error }}]</span>
                {% endfor %}
            </label>
          </p>

          <p>
            <label for="colour">
              Beer colour
                <div class="input-group" style="width: 120px;">
                  {{ new_beer.colour(class_="form-control") }}
                  <div class="input-group-addon" id="new_beer_colour">
                    EBC
                  </div>
                </div>
                {% for error in new_beer.colour.errors %}
                  <span style="color: #f33;">[{{ error }}]</span>
                {% endfor %}
            </label>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          {{ new_beer.submit(class_="btn btn-primary") }}
        </div>
      </div>
    </form>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal fade" id="edit-beer-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <form action="" method="post" name="edit_beer">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Update </h4>
        </div>
        <div class="modal-body">
          {{ edit_beer.hidden_tag() }}
          <p>
            <label for="name">
              Beer name
                {{ edit_beer.name(size="40", class_="form-control") }}
                {% for error in edit_beer.name.errors %}
                  <span style="color: #f33;">[{{ error }}]</span>
                {% endfor %}
            </label>
          </p>

          <p>
            <label for="style">
              Beer style
                {{ edit_beer.style(size="40", class_="form-control") }}
                {% for error in edit_beer.style.errors %}
                  <span style="color: #f33;">[{{ error }}]</span>
                {% endfor %}
            </label>
          </p>

          <p>
            <label for="abv">
              Beer ABV
                <div class="input-group" style="width: 100px;">
                  {{ edit_beer.abv(size="20", class_="form-control") }}
                  <div class="input-group-addon">
                    %
                  </div>
                </div>
                {% for error in edit_beer.abv.errors %}
                  <span style="color: #f33;">[{{ error }}]</span>
                {% endfor %}
            </label>
          </p>

          <p>
            <label for="colour">
              Beer colour
                <div class="input-group" style="width: 120px;">
                  {{ edit_beer.colour(class_="form-control") }}
                  <div class="input-group-addon" id="edit_beer_colour">
                    EBC
                  </div>
                </div>
                {% for error in edit_beer.colour.errors %}
                  <span style="color: #f33;">[{{ error }}]</span>
                {% endfor %}
            </label>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          {{ edit_beer.submit(value="Save changes", class_="btn btn-primary") }}
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block endbody %}
<script type="text/javascript">
{% for beer in brewery.beers %}
  $("#colour{{beer.id}}").css("background-color",get_hex_from_ebc({{ beer.colour }}));
  $()
{% endfor %}

$("input#colour").on("input", function() {
  update_colour_field("input#colour", "#new_beer_colour");
});

{% if new_beer.errors %}
  $("#new-beer-modal").modal('show');
{% endif %}
{% if edit_beer.errors %}
  $("#edit-beer-modal").modal('show');
{% endif %}

$("a[name='edit_beer']").on('click', function() {
  $.getJSON($SCRIPT_ROOT + '/beer/' + $(this).data("beer-id") + '/detail.json',
    {},
    function(data) {
      $("form[name='edit_beer'] input#name").val(data[0][1]);
      $("form[name='edit_beer'] input#style").val(data[0][2]);
      $("form[name='edit_beer'] input#abv").val(data[0][3]);
      $("form[name='edit_beer'] input#colour").val(data[0][4]);
      update_colour_field("form[name='edit_beer'] input#colour", "#edit_beer_colour");
      $("#edit-beer-modal h4.modal-title").text("Edit " + data[0][1])
      $("form[name='edit_beer']").attr("action", $SCRIPT_ROOT + "/beer/" + data[0][0] + "/edit");
      $("#edit-beer-modal").modal('show');
    });
    return false;
});

function update_colour_field(field, label) {
  if(!$(field).val()) {
    $(label).css({
      "background-color": "#eee",
      "color": "#555"
    });
    return false;
  }
  if($(field).val() < 10) {
    $(label).css({
      "background-color": get_hex_from_ebc($(field).val()),
      "color": "#555"
    });
  } else {
    $(label).css({
      "background-color": get_hex_from_ebc($(field).val()),
      "color": "#fff"
    });
  }
}
</script>


</script>
{% endblock %}
