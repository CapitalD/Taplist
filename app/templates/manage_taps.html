{% extends "layout.html" %}
{% block body %}

<div class="page-header">
  {% if manageable_locations|length > 1 %}
    <div class="btn-toolbar pull-right">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Switch location
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          {% for ml in manageable_locations|sort(attribute='name') %}
            <li><a href="{{ url_for('manage_taps', id=ml.id) }}">{{ ml.name }}</a></li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}

  <h1>Manage taps at {{ location.name }}</h1>
</div>

<div class="row">
  <div class="col-lg-10 col-lg-offset-1 col-xs-12">
    <div class="btn-toolbar pull-right">
      <div class="btn-group" role="group" aria-label="tap actions">
        <button type="button" class="btn btn-default"  data-toggle="modal" data-target="#new-tap-modal" name="new_tap">Add tap...</button>

        <div class="btn-group" role="group">
          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Remove tap
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu">
            {% for t in taps|sort(attribute='id') %}
              <li><a href="{{ url_for('delete_tap', loc_id = t.location.id, tap_id=t.id) }}">{{ t.label }}</a></li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-lg-10 col-lg-offset-1 col-xs-12">

    <div class="row">
      <div class="col-xs-12">
        <table class="table table-hover" id="manage_taps">
          <thead>
            <tr>
              <th>Brewery</th>
              <th>Beer</th>
              <th>Style</th>
              <th>ABV / EBC</th>
            </tr>
          </thead>
          <tbody>
          {% for tap in taps|sort(attribute='id') %}
            <tr>
              <td colspan="3"><h4>Tap: {{tap.label}}</h4></td>
              {% if tap.beer %}
              <td><button type="button" name="clear_tap" class="btn btn-sm btn-default" data-tap-id="{{tap.id}}">Clear tap</button></td>
              {% else %}
              <td><button type="button" name="tap_keg" class="btn btn-sm btn-default" data-toggle="modal" data-target="#tap-keg-modal" data-tap-id="{{tap.id}}">Tap a keg</button></td>
              {% endif %}
            </tr>
            <tr>
              {% if tap.beer %}
              <td>{{tap.beer.brewery.name}}</td>
              <td>{{tap.beer.name}}</td>
              <td>{{tap.beer.style}}</td>
              <td>{{tap.beer.abv}}% <span class="label" id="tap_label{{tap.id}}">{{tap.beer.colour}}</span></td>
              {% else %}
              <td colspan="4">Nothing pouring</td>
              {% endif %}
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="tap-keg-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <form action="" method="post" name="manage_taps">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Tap a keg</h4>
        </div>
        <div class="modal-body">
          {{ keg_form.hidden_tag() }}
          <p>
            <label for="brewery">
              Brewery
                {{ keg_form.brewery(class_="form-control") }}
            </label>
          </p>

          <p>
            <label for="beer">
              Beer
                {{ keg_form.beer(class_="form-control", disabled=true) }}
            </label>
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          {{ keg_form.tap_keg(class_="btn btn-primary") }}
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="new-tap-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <form action="" method="post" name="new_tap">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Add a tap</h4>
        </div>
        <div class="modal-body">
          {{ new_tap_form.hidden_tag() }}
          <p>
            <label for="label">
              Label
                {{ new_tap_form.label(class_="form-control") }}
            </label>
          </p>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          {{ new_tap_form.add_tap(class_="btn btn-primary") }}
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block endbody %}
<script type="text/javascript">
{% for tap in taps %}
  $("span#tap_label{{tap.id}}").css("background-color",get_hex_from_ebc({{tap.beer.colour}}));
{% endfor %}

$("button[name='clear_tap']").on('click', function() {
  window.location.href = $SCRIPT_ROOT + "/tap/" + $(this).data("tap-id") + "/clear";
});

$("button[name='tap_keg']").on('click', function() {
  $("#tap_id").val($(this).data("tap-id"));
  $("form[name='manage_taps']").attr("action", $SCRIPT_ROOT + "/tap/" + $(this).data("tap-id") + "/set");
});

$("button[name='new_tap']").on('click', function() {
  $("#location_id").val({{ location.id }});
  $("form[name='new_tap']").attr("action", $SCRIPT_ROOT + "/location/" + {{ location.id }} + "/tap/new");
});

$("select#brewery").on('change', function() {
  if (isNaN($(this).val())) {
    $("#beer").empty();
    $("#beer").append(
      $("<option></option>").attr(
        "value", 0).text("Choose a brewery before choosing a beer")
    );
    $("#beer").prop("disabled", true);
    return false;
  }

  $.getJSON($SCRIPT_ROOT + '/brewery/' + $("select[name='brewery']").val() + '/beers.json',
    {},
    function(data) {
      $("#beer").empty();
      for (i = 0; i < data.length; i++) {
        $("#beer").append(
          $("<option></option>").attr(
            "value", data[i][0]).text(data[i][1])
        );
      }
    });
    $("#beer").prop("disabled", false)
    return false;
});
</script>
{% endblock %}
